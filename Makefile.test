################################################################################
# Simplified Testing Makefile Extension
################################################################################
#
# Essential testing targets:
#   make test-all         - Run all tests with coverage (REQUIRED BY CI)
#   make test             - Quick tests without coverage
#   make test-playwright  - Integration tests (REQUIRED BY CI)
#
################################################################################

.PHONY: test-all test test-backend test-frontend test-playwright-build test-playwright test-playwright-oscilloscope test-ensure-containers test-start test-stop test-smart

# Detect which docker compose command to use (for CI compatibility)
DOCKER_COMPOSE := $(shell which docker-compose 2>/dev/null || echo "docker compose")

# Ensure testing containers are running (auto-start if needed)
test-ensure-containers: ## Ensure testing containers are running
	@if ! docker ps | grep -q "durable-code-python-tester-$(BRANCH_NAME)"; then \
		echo "$(CYAN)Starting Python testing container...$(NC)"; \
		$(DOCKER_COMPOSE) -f .docker/compose/test.yml up -d python-tester; \
	fi
	@if ! docker ps | grep -q "durable-code-js-tester-$(BRANCH_NAME)"; then \
		echo "$(CYAN)Starting JS testing container...$(NC)"; \
		$(DOCKER_COMPOSE) -f .docker/compose/test.yml up -d js-tester; \
	fi
	@echo "$(GREEN)✓ Testing containers ready$(NC)"

# Start dedicated testing containers (force start)
test-start: ## Start dedicated testing containers
	@echo "$(CYAN)Starting dedicated testing containers...$(NC)"
	@$(DOCKER_COMPOSE) -f .docker/compose/test.yml up -d --build
	@echo "$(GREEN)✓ Testing containers started$(NC)"

# Stop dedicated testing containers
test-stop: ## Stop dedicated testing containers
	@echo "$(CYAN)Stopping dedicated testing containers...$(NC)"
	@$(DOCKER_COMPOSE) -f .docker/compose/test.yml down
	@echo "$(GREEN)✓ Testing containers stopped$(NC)"

# Smart test execution - only test what changed
test-smart: ## Run tests only for changed files
	@echo "$(CYAN)Detecting changes and running relevant tests...$(NC)"
	@BACKEND_CHANGED=$$(git diff --cached --name-only | grep -E "^(durable-code-app/backend|tools|test)/" | head -1); \
	FRONTEND_CHANGED=$$(git diff --cached --name-only | grep -E "^durable-code-app/frontend/" | head -1); \
	if [ -n "$$BACKEND_CHANGED" ]; then \
		echo "$(YELLOW)Backend changes detected - running backend tests...$(NC)"; \
		$(MAKE) test-backend; \
	fi; \
	if [ -n "$$FRONTEND_CHANGED" ]; then \
		echo "$(YELLOW)Frontend changes detected - running frontend tests...$(NC)"; \
		$(MAKE) test-frontend; \
	fi; \
	if [ -z "$$BACKEND_CHANGED" ] && [ -z "$$FRONTEND_CHANGED" ]; then \
		echo "$(YELLOW)No relevant changes detected - skipping tests$(NC)"; \
	fi

# Main testing targets - REQUIRED BY GITHUB ACTIONS
test-all: dev-start test-ensure-containers test-backend-coverage test-frontend-coverage test-playwright ## Run all tests with coverage
	@echo "$(GREEN)✅ All tests completed with coverage!$(NC)"

# Quick testing without coverage
test: test-ensure-containers ## Run all tests quickly (no coverage)
	@echo "$(CYAN)╔════════════════════════════════════════════════════════════╗$(NC)"
	@echo "$(CYAN)║                    Quick Test Suite                       ║$(NC)"
	@echo "$(CYAN)╚════════════════════════════════════════════════════════════╝$(NC)"
	@echo "$(YELLOW)Running backend tests...$(NC)"
	@docker exec durable-code-python-tester-$(BRANCH_NAME) bash -c "cd /app && pytest test/ -v" || echo "$(YELLOW)Backend tests completed with some failures$(NC)"
	@echo "$(YELLOW)Running frontend tests...$(NC)"
	@docker exec durable-code-js-tester-$(BRANCH_NAME) npm run test:run
	@echo "$(GREEN)✓ Quick tests complete$(NC)"

# Backend Python tests
test-backend: test-ensure-containers ## Run backend tests with coverage
	@echo "$(CYAN)╔════════════════════════════════════════════════════════════╗$(NC)"
	@echo "$(CYAN)║              Backend Tests with Coverage                  ║$(NC)"
	@echo "$(CYAN)╚════════════════════════════════════════════════════════════╝$(NC)"
	@echo "$(YELLOW)Running backend and framework tests with coverage...$(NC)"
	@docker exec durable-code-python-tester-$(BRANCH_NAME) bash -c "cd /app && pytest test/ --cov=app --cov=tools/design_linters --cov-report=term --cov-report=term:skip-covered --tb=short -v" || echo "$(YELLOW)Tests completed with some failures$(NC)"
	@echo "$(GREEN)✓ Backend tests complete$(NC)"

# Internal target for CI
test-backend-coverage: test-backend

# Frontend JavaScript/TypeScript tests
test-frontend: test-ensure-containers ## Run frontend tests
	@echo "$(CYAN)╔════════════════════════════════════════════════════════════╗$(NC)"
	@echo "$(CYAN)║                    Frontend Tests                         ║$(NC)"
	@echo "$(CYAN)╚════════════════════════════════════════════════════════════╝$(NC)"
	@echo "$(YELLOW)Running frontend tests...$(NC)"
	@docker exec durable-code-js-tester-$(BRANCH_NAME) npm run test:run
	@echo "$(GREEN)✓ Frontend tests complete$(NC)"

# Frontend tests with coverage
test-frontend-coverage: test-ensure-containers ## Run frontend tests with coverage
	@echo "$(CYAN)╔════════════════════════════════════════════════════════════╗$(NC)"
	@echo "$(CYAN)║            Frontend Tests with Coverage                   ║$(NC)"
	@echo "$(CYAN)╚════════════════════════════════════════════════════════════╝$(NC)"
	@echo "$(YELLOW)Running frontend tests with coverage...$(NC)"
	@docker exec durable-code-js-tester-$(BRANCH_NAME) npm run test:coverage
	@echo "$(GREEN)✓ Frontend coverage tests complete$(NC)"

# Playwright integration tests - REQUIRED BY GITHUB ACTIONS
test-playwright-build: ## Build Playwright test container
	@echo "$(CYAN)Building Playwright test container...$(NC)"
	@docker build -f .docker/dockerfiles/testing/Dockerfile.playwright -t playwright-tests test/integration_test/
	@echo "$(GREEN)✓ Playwright container built$(NC)"

test-playwright: dev-start test-playwright-build ## Run Playwright integration tests
	@echo "$(CYAN)Running Playwright integration tests...$(NC)"
	@if [ "$(CI)" = "true" ]; then \
		docker run --rm --network compose_durable-network-dev \
			-e PLAYWRIGHT_BROWSERS_PATH=/ms-playwright \
			-e BRANCH_NAME="$(BRANCH_NAME)" \
			-e FRONTEND_PORT="$(FRONTEND_PORT)" \
			-e BACKEND_PORT="$(BACKEND_PORT)" \
			-e USE_HOST_NETWORK=false \
			playwright-tests; \
	else \
		docker run --rm --network host \
			-e PLAYWRIGHT_BROWSERS_PATH=/ms-playwright \
			-e BRANCH_NAME="$(BRANCH_NAME)" \
			-e FRONTEND_PORT="$(FRONTEND_PORT)" \
			-e BACKEND_PORT="$(BACKEND_PORT)" \
			-e USE_HOST_NETWORK=true \
			playwright-tests; \
	fi
	@echo "$(GREEN)✓ Playwright tests complete$(NC)"

test-playwright-oscilloscope: dev-start test-playwright-build ## Run oscilloscope Playwright tests (REQUIRED BY CI)
	@echo "$(CYAN)Running oscilloscope integration tests...$(NC)"
	@if [ "$(CI)" = "true" ]; then \
		docker run --rm --network compose_durable-network-dev \
			-e PLAYWRIGHT_BROWSERS_PATH=/ms-playwright \
			-e BRANCH_NAME="$(BRANCH_NAME)" \
			-e FRONTEND_PORT="$(FRONTEND_PORT)" \
			-e BACKEND_PORT="$(BACKEND_PORT)" \
			-e USE_HOST_NETWORK=false \
			playwright-tests pytest -v test_oscilloscope_playwright.py; \
	else \
		docker run --rm --network host \
			-e PLAYWRIGHT_BROWSERS_PATH=/ms-playwright \
			-e BRANCH_NAME="$(BRANCH_NAME)" \
			-e FRONTEND_PORT="$(FRONTEND_PORT)" \
			-e BACKEND_PORT="$(BACKEND_PORT)" \
			-e USE_HOST_NETWORK=true \
			playwright-tests pytest -v test_oscilloscope_playwright.py; \
	fi
	@echo "$(GREEN)✓ Oscilloscope tests complete$(NC)"